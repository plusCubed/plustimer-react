<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Authenticate with WCA</title>
</head>
<body style="font-family: sans-serif;">

Please wait...

<!-- Import and configure the Firebase SDK -->
<!-- These scripts are made available when the app is served or deployed on Firebase Hosting -->
<!-- If you do not serve/host your project using Firebase Hosting see https://firebase.google.com/docs/web/setup -->

<% if (process.env.NODE_ENV === 'production') { %>
    <script src="/__/firebase/4.8.1/firebase-app.js"></script>
    <script src="/__/firebase/4.8.1/firebase-auth.js"></script>
    <script src="/__/firebase/4.8.1/firebase-firestore.js"></script>
    <script src="/__/firebase/init.js"></script>
<% } else { %>
    <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase-firestore.js"></script>
    <script>
      var config = <%= JSON.stringify(require('./utils/firebaseConfigDebug').default) %>;
      firebase.initializeApp(config);
    </script>
<% } %>

<script>
  /**
   * Returns the value of the given URL query parameter.
   */
  function getURLParameter(name) {
    return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) ||
      [null, ''])[1].replace(/\+/g, '%20')) || null;
  }
  /**
   * Returns the ID of the Firebase project.
   */
  function getFirebaseProjectId() {
    return firebase.app().options.projectId;
  }
  /**
   * This callback is called by the JSONP callback of the 'token' Firebase Function with the Firebase auth token.
   */
  function tokenReceived(data) {
    if (data.token) {
      firebase.auth()
        .onAuthStateChanged(function (user) {
          if (user && !user.isAnonymous) {
            //window.close();
          }
        });

      firebase.auth().signOut()
        .catch(function (error) { console.log(error); })
        .then(firebase.auth().signInWithCustomToken(data.token))
        .catch(function (error) { console.log(error);})
        .then(function () {
          setTimeout(function(){
            window.close();
          }, 1000);
        });
    } else {
      console.error(data);
      document.body.innerText = 'Error in the token function: ' + data.error;
    }
  }

  var DEBUG = <%= process.env.FIREBASE_ENV === 'local' %>;
  var functionsUrl =  DEBUG ?
    'http://localhost:5001/' + getFirebaseProjectId() + '/us-central1':
    'https://us-central1-' + getFirebaseProjectId() + '.cloudfunctions.net';

  var code = getURLParameter('code');
  var state = getURLParameter('state');
  var error = getURLParameter('error');
  var oldIdToken = getURLParameter('oldIdToken');
  if (error) {
    document.body.innerText = 'Error from the WCA auth page: ' + error;
  } else if(!code) {
    // Start the auth flow.
    var url = functionsUrl + '/redirect';
    if(oldIdToken){
      url = url + '?oldIdToken=' + oldIdToken;
    }
    window.location.href  = url;
  } else {
    // Use JSONP to load the 'token' Firebase Function to exchange the auth code against a Firebase custom token.
    var script = document.createElement('script');
    script.type = 'text/javascript';
    // This is the URL to the HTTP triggered 'token' Firebase Function.
    // See https://firebase.google.com/docs/functions.
    var tokenFunctionURL = functionsUrl + '/token';
    script.src = tokenFunctionURL +
      '?code=' + encodeURIComponent(code) +
      '&state=' + encodeURIComponent(state) +
      '&callback=' + tokenReceived.name;
    document.head.appendChild(script);
  }
</script>
</body>
</html>